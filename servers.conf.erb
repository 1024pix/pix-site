log_format keyvalue
  'method=$request_method'
  ' path="$request_uri"'
  ' host=$host'
  ' request_id=$http_x_request_id'
  ' from="$remote_addr"'
  ' protocol=$scheme'
  ' status=$status'
  ' duration=${request_time}s'
  ' bytes=$bytes_sent'
  ' referer="$http_referer"'
  ' user_agent="$http_user_agent"';

# In order to avoid logging access twice per request
# it is necessary to turn off the top-level (e.g. http) buildpack default access_log
# as we are about to override it in the server directive here below
access_log off;

port_in_redirect off;

server {
  listen <%= ENV['PORT'] %>;

  charset utf-8;

  # Disable compression that is performed by the Scalingo router anyway
  gzip off;

  root /app/dist/;

  rewrite ^/(aide|help)$ https://support.pix.org redirect;
  rewrite ^/employeurs$ https://pro.<%= ENV['DOMAIN_FR'] %> redirect;

  error_page 400 401 403 404 418 500 502 503 504 /404.html;

  location ~ ^/(_assets|_nuxt|images|scripts)/ {
    expires 1y;
    add_header Cache-Control public;
    add_header ETag "";
  }

  # Localized pages must not exist on pix.fr
  location ~ ^/(fr-be|en-gb|fr)/ {
    if ($host ~ \.fr) {
      return 404;
    }
  }

  location ~ ^/(fr-be|en-gb|fr)/ {
    if ($http_x_forwarded_host ~ \.fr) {
      return 404;
    }
  }

  if ($host ~ \.org) {
    rewrite ^/(?!404.html)(?!fr-be)(?!fr)(?!en-gb)(?!_assets)(?!_nuxt)(?!documents)(?!images)(?!scripts)(?!apple-touch-icon)(?!favicon)(?!robots\.txt) $scheme://$host/fr$request_uri redirect;
  }

  if ($http_x_forwarded_host ~ \.org) {
    rewrite ^/(?!404.html)(?!fr-be)(?!fr)(?!en-gb)(?!_assets)(?!_nuxt)(?!documents)(?!images)(?!scripts)(?!apple-touch-icon)(?!favicon)(?!robots\.txt) $http_x_forwarded_proto://$http_x_forwarded_host/fr$request_uri redirect;
  }
}
